<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Reading Chat - Dante's Inferno (v2)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Using Tailwind CDN for single HTML file - acceptable for this use case -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        
        .word-display {
            font-size: 2rem;
            line-height: 1.2;
            font-family: 'Arial', sans-serif;
        }
        
        .word-display strong {
            font-weight: 800 !important;
            color: #f59e0b !important;
        }
        
        @media (max-width: 768px) {
            .word-display {
                font-size: 1.5rem;
            }
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        
        .user-message {
            background-color: #374151;
            margin-left: 2rem;
        }
        
        .assistant-message {
            background-color: #1f2937;
            margin-right: 2rem;
        }
        
        .error-message {
            background-color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
        
        .debug-panel {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-loading { background-color: #f59e0b; }
        .status-idle { background-color: #6b7280; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function ErrorBoundary({ children }) {
            const [hasError, setHasError] = useState(false);
            
            if (hasError) {
                return (
                    <div className="min-h-screen bg-black text-white p-4 flex items-center justify-center">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold mb-4">Something went wrong</h1>
                            <button 
                                onClick={() => window.location.reload()} 
                                className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded"
                            >
                                Reload Page
                            </button>
                        </div>
                    </div>
                );
            }
            
            return children;
        }

        function SpeedReadingChat() {
            const [apiKey, setApiKey] = useState('');
            const [message, setMessage] = useState('');
            const [chatHistory, setChatHistory] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [currentWord, setCurrentWord] = useState('');
            const [wordIndex, setWordIndex] = useState(0);
            const [currentSentence, setCurrentSentence] = useState([]);
            const [sentenceIndex, setSentenceIndex] = useState(0);
            const [isReading, setIsReading] = useState(false);
            const [alignment, setAlignment] = useState('left');
            const [wordDuration, setWordDuration] = useState(200);
            const [showIntro, setShowIntro] = useState(false);
            const [showDebug, setShowDebug] = useState(false);
            const [debugLog, setDebugLog] = useState([]);
            const [apiStatus, setApiStatus] = useState('idle');
            const [lastApiResponse, setLastApiResponse] = useState(null);
            const [lastApiError, setLastApiError] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(true);
            const [demoText, setDemoText] = useState('');
            
            const wordTimeoutRef = useRef(null);
            const chatContainerRef = useRef(null);

            const addDebugLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setDebugLog(prev => [...prev, { timestamp, message, type }]);
            };

            const testApiConnection = async () => {
                if (!apiKey) {
                    addDebugLog('No API key provided', 'error');
                    return false;
                }

                setApiStatus('loading');
                addDebugLog('Testing API connection...', 'info');

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: 'Hello'
                                }]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok && data.candidates) {
                        setApiStatus('success');
                        addDebugLog('API connection successful', 'success');
                        setLastApiResponse(data);
                        return true;
                    } else {
                        setApiStatus('error');
                        setLastApiError(data);
                        addDebugLog(`API Error: ${data.error?.message || 'Unknown error'}`, 'error');
                        return false;
                    }
                } catch (error) {
                    setApiStatus('error');
                    setLastApiError({ error: { message: error.message } });
                    addDebugLog(`Network Error: ${error.message}`, 'error');
                    return false;
                }
            };

            const calculateWordDuration = (word) => {
                // Check if this is a combined word (contains space)
                if (word.includes(' ')) {
                    const words = word.split(' ');
                    let totalDuration = 0;
                    for (const singleWord of words) {
                        totalDuration += calculateWordDuration(singleWord);
                    }
                    return totalDuration;
                }
                
                // Base duration per character (from slider)
                const baseDurationPerChar = wordDuration / 5; // Normalize to 5 characters
                
                // Calculate duration based on word length
                let duration = word.length * baseDurationPerChar;
                
                // Add extra pause for punctuation
                let punctuationPause = 0;
                if (word.match(/[.!?]/)) {
                    punctuationPause = 1000; // 1000ms extra for sentence endings
                } else if (word.match(/[,;]/)) {
                    punctuationPause = 600; // 600ms extra for commas and semicolons
                } else if (word.match(/[:'"()]/)) {
                    punctuationPause = 400; // 400ms extra for other punctuation
                }
                
                return duration + punctuationPause;
            };

            const applyFixation = (word) => {
                try {
                    if (!word || typeof word !== 'string') {
                        return word || '';
                    }
                    
                    // Check if this is a combined word (contains space)
                    if (word.includes(' ')) {
                        const words = word.split(' ');
                        return words.map(singleWord => applyFixation(singleWord)).join(' ');
                    }
                    
                    const length = word.length;
                    let boldCount = 0;
                    
                    if (length <= 3) {
                        boldCount = 1;
                    } else if (length === 4) {
                        boldCount = 2;
                    } else if (length === 5) {
                        boldCount = 2;
                    } else if (length === 6) {
                        boldCount = 3;
                    } else if (length > 6) {
                        boldCount = 4;
                    } 
                    
                    // Calculate which letters to bold
                    let boldIndices = [];
                    for (let i = 0; i < boldCount; i++) {
                        boldIndices.push(i);
                    }
                    
                    // Apply bold formatting
                    let result = '';
                    for (let i = 0; i < length; i++) {
                        if (boldIndices.includes(i)) {
                            result += `<strong>${word[i]}</strong>`;
                        } else {
                            result += word[i];
                        }
                    }
                    
                    return result;
                } catch (error) {
                    console.error('Error in applyFixation:', error);
                    return word || '';
                }
            };

            const displayNextWord = () => {
                if (currentSentence.length > 0 && sentenceIndex < currentSentence.length) {
                    const currentSentenceText = currentSentence[sentenceIndex];
                    const words = currentSentenceText.split(/\s+/).filter(word => word.trim());
                    
                    // Debug: Log all words in current sentence
                    if (wordIndex === 0) {
                        addDebugLog(`Sentence words: [${words.map(w => `"${w}"`).join(', ')}]`, 'info');
                    }
                    
                    if (wordIndex < words.length) {
                        let word = words[wordIndex];
                        let combinedWord = word;
                        let skipNext = false;
                        
                        addDebugLog(`Processing word ${wordIndex}: "${word}"`, 'info');
                        
                        // Check if current word is just punctuation
                        if (word.match(/^[.!?,;:'"()]+$/)) {
                            addDebugLog(`Found punctuation: "${word}"`, 'info');
                            // If it's punctuation, combine with previous word
                            if (wordIndex > 0) {
                                const prevWord = words[wordIndex - 1];
                                combinedWord = prevWord + word;
                                // We need to go back and update the previous display
                                setCurrentWord(combinedWord);
                                const duration = calculateWordDuration(combinedWord);
                                addDebugLog(`Combined punctuation: "${prevWord}" + "${word}" = "${combinedWord}"`, 'info');
                                
                                wordTimeoutRef.current = setTimeout(() => {
                                    setWordIndex(prev => prev + 1);
                                }, duration);
                                return;
                            }
                        }
                        
                        // Combine 1-2 character words with the next word (but not if next is punctuation)
                        if (word.length <= 2 && wordIndex + 1 < words.length) {
                            const nextWord = words[wordIndex + 1];
                            // Don't combine if next word is just punctuation
                            if (!nextWord.match(/^[.!?,;:'"()]+$/)) {
                                combinedWord = word + ' ' + nextWord;
                                skipNext = true;
                                addDebugLog(`Combined: "${word}" + "${nextWord}" = "${combinedWord}"`, 'info');
                            }
                        }
                        
                        setCurrentWord(combinedWord);
                        const duration = calculateWordDuration(combinedWord);
                        
                        // Debug logging
                        addDebugLog(`Word: "${combinedWord}" (${combinedWord.length} chars) - Duration: ${duration}ms`, 'info');
                        
                        wordTimeoutRef.current = setTimeout(() => {
                            setWordIndex(prev => prev + (skipNext ? 2 : 1));
                        }, duration);
                    } else {
                        // Move to next sentence
                        setSentenceIndex(prev => prev + 1);
                        setWordIndex(0);
                        if (sentenceIndex + 1 >= currentSentence.length) {
                            setIsReading(false);
                            setCurrentWord('');
                            setSentenceIndex(0);
                            setWordIndex(0);
                        }
                    }
                } else {
                    setIsReading(false);
                    setCurrentWord('');
                    setSentenceIndex(0);
                    setWordIndex(0);
                }
            };

            useEffect(() => {
                if (isReading && currentSentence.length > 0) {
                    displayNextWord();
                }
                
                return () => {
                    if (wordTimeoutRef.current) {
                        clearTimeout(wordTimeoutRef.current);
                    }
                };
            }, [isReading, wordIndex, sentenceIndex, currentSentence]);

            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [chatHistory]);

            // Auto-start with Dante text when component loads
            useEffect(() => {
                const startDanteReading = () => {
                    const sampleTexts = getSampleTexts();
                    const danteText = sampleTexts[0].text;
                    
                    // Split into sentences for speed reading, but keep punctuation with words
                    const sentences = danteText.split(/(?<=[.!?])\s+/).filter(s => s.trim());
                    setCurrentSentence(sentences);
                    setSentenceIndex(0);
                    setIsReading(true);
                    addDebugLog(`Started reading Il Sentiero dei Nidi di Ragno - ${sentences.length} sentences`, 'success');
                };

                // Start reading after component mount
                const timer = setTimeout(() => {
                    startDanteReading();
                }, 1000);
                return () => clearTimeout(timer);
            }, []);

            const sendMessage = async () => {
                if (!message.trim()) {
                    addDebugLog('Message is empty', 'error');
                    return;
                }
                
                const userMessage = { role: 'user', content: message };
                setChatHistory(prev => [...prev, userMessage]);
                setMessage('');
                setIsLoading(true);
                addDebugLog(`Sending message: "${message.substring(0, 50)}${message.length > 50 ? '...' : ''}"`, 'info');

                if (isDemoMode) {
                    // Demo mode - use sample text
                    setTimeout(() => {
                        const sampleTexts = getSampleTexts();
                        const randomText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                        const assistantMessage = { role: 'assistant', content: randomText.text };
                        setChatHistory(prev => [...prev, assistantMessage]);
                        setApiStatus('success');
                        
                        addDebugLog(`Demo response: ${randomText.title}`, 'success');
                        
                        // Split response into sentences for speed reading
                        const sentences = randomText.text.split(/([.!?]+)/).filter(s => s.trim());
                        setCurrentSentence(sentences);
                        setSentenceIndex(0);
                        setIsReading(true);
                        addDebugLog(`Split into ${sentences.length} sentences for speed reading`, 'info');
                        setIsLoading(false);
                    }, 1000); // Simulate API delay
                } else {
                    // API mode
                    if (!apiKey) {
                        addDebugLog('API key missing', 'error');
                        setIsLoading(false);
                        return;
                    }
                    
                    setApiStatus('loading');
                    
                    try {
                        const requestBody = {
                            contents: [{
                                parts: [{
                                    text: message
                                }]
                            }]
                        };

                        addDebugLog(`Request URL: https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent`, 'info');
                        addDebugLog(`Request body: ${JSON.stringify(requestBody, null, 2)}`, 'info');

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });

                        addDebugLog(`Response status: ${response.status} ${response.statusText}`, 'info');

                        const data = await response.json();
                        setLastApiResponse(data);
                        
                        if (response.ok && data.candidates && data.candidates[0] && data.candidates[0].content) {
                            const assistantResponse = data.candidates[0].content.parts[0].text;
                            const assistantMessage = { role: 'assistant', content: assistantResponse };
                            setChatHistory(prev => [...prev, assistantMessage]);
                            setApiStatus('success');
                            
                            addDebugLog(`Response received: ${assistantResponse.substring(0, 100)}${assistantResponse.length > 100 ? '...' : ''}`, 'success');
                            
                            // Split response into sentences for speed reading
                            const sentences = assistantResponse.split(/([.!?]+)/).filter(s => s.trim());
                            setCurrentSentence(sentences);
                            setSentenceIndex(0);
                            setIsReading(true);
                            addDebugLog(`Split into ${sentences.length} sentences for speed reading`, 'info');
                        } else {
                            setApiStatus('error');
                            setLastApiError(data);
                            const errorMsg = data.error?.message || 'Invalid response from API';
                            addDebugLog(`API Error: ${errorMsg}`, 'error');
                            addDebugLog(`Full error response: ${JSON.stringify(data, null, 2)}`, 'error');
                            
                            const errorMessage = { role: 'assistant', content: `Error: ${errorMsg}. Please check your API key and try again.` };
                            setChatHistory(prev => [...prev, errorMessage]);
                        }
                    } catch (error) {
                        setApiStatus('error');
                        setLastApiError({ error: { message: error.message } });
                        addDebugLog(`Network Error: ${error.message}`, 'error');
                        addDebugLog(`Error stack: ${error.stack}`, 'error');
                        
                        const errorMessage = { role: 'assistant', content: `Network Error: ${error.message}. Please check your internet connection and try again.` };
                        setChatHistory(prev => [...prev, errorMessage]);
                    } finally {
                        setIsLoading(false);
                    }
                }
            };

            const handleNextSentence = () => {
                if (sentenceIndex < currentSentence.length - 1) {
                    setSentenceIndex(prev => prev + 1);
                    setWordIndex(0);
                    setIsReading(true);
                    addDebugLog(`Moving to sentence ${sentenceIndex + 2}/${currentSentence.length}`, 'info');
                } else {
                    setCurrentSentence([]);
                    setSentenceIndex(0);
                    setWordIndex(0);
                    setIsReading(false);
                    addDebugLog('Finished reading all sentences', 'info');
                }
            };

            const handleRewindPhrase = () => {
                setSentenceIndex(0);
                setWordIndex(0);
                setIsReading(true);
                addDebugLog('Rewound to beginning of phrase', 'info');
            };

            const handleRewindWords = () => {
                const newWordIndex = Math.max(0, wordIndex - 5);
                setWordIndex(newWordIndex);
                setIsReading(true);
                addDebugLog(`Rewound 5 words to word ${newWordIndex}`, 'info');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const clearDebugLog = () => {
                setDebugLog([]);
                addDebugLog('Debug log cleared', 'info');
            };

            const getSampleTexts = () => [
                {
                    title: "Il Sentiero dei Nidi di Ragno",
                    text: "Per arrivare fino in fondo al vicolo, i raggi del sole devono scendere diritti rasente le pareti fredde, tenute discoste a forza d'arcate che traversano la striscia di cielo azzurro carico. Scendono diritti, i raggi del sole, giù per le finestre messe qua e là in disordine sui muri, e cespi di basilico e di origano piantati dentro pentole ai davanzali, e sottovesti stese appese a corde; fin giù al selciato, fatto a gradini e a ciottoli, con una cunetta in mezzo per l'orina dei muli. Basta un grido di Pin, un grido per incominciare una canzone, a naso all'aria sulla soglia della bottega, o un grido cacciato prima che la mano di Pietromagro il ciabattino gli sia scesa tra capo e collo per picchiarlo, perché dai davanzali nasca un'eco di richiami e d'insulti. - Pin! Già a quest'ora cominci ad angosciarci! Cantacene un po' una, Pin! Pin, meschinetto, cosa ti fanno? Pin, muso di macacco! Ti si seccasse la voce in gola, una volta! Tu e quel rubagalline del tuo padrone! Tu e quel materasso di tua sorella! Ma già Pin è in mezzo al carrugio, con le mani nelle tasche della giacca troppo da uomo per lui, che li guarda in faccia uno per uno senza ridere: - Di' Celestino, sta' un po' zitto, bel vestito nuovo che hai. E-di', quel furto di stoffa ai Moli Nuovi, poi, non si sa ancora chi sia stato? Be', che c'entra. Ciao Carolina, meno male quella volta. Si, quella volta meno male tuo marito che non ha guardato sotto il letto. Anche tu, Pasca, m'han detto che è successo proprio al tuo paese. Sì, che Garibaldi ci ha portato il sapone e i tuoi paesani se lo son mangiato. Mangiasapone, Pasca, mondoboia, lo sapete quanto costa il sapone? Pin ha una voce rauca da bambino vecchio: dice ogni battuta a bassa voce, serio, poi tutt'a un tratto sbotta in una risata in i che sembra un fischio e le lentiggini rosse e nere gli si affollano intorno agli occhi come un volo di vespe. A canzonare Pin c'è sempre da rimettere: conosce tutti i fatti del carrugio e non si sa mai cosa va a tirar fuori. Mattina e sera sotto le finestre a sgolarsi in canzoni e in gridi, mentre nella bottega di Pietromagro la montagna di scarpe sfondate tra poco seppellisce il deschetto e trabocca in istrada. - Pin! Macacco! Muso brutto! - gli grida qualche donna. - Mi risuolassi quelle ciabatte invece di starci ad angosciare tutto il giorno! È un mese che le avete lì nel mucchio. Lo dirò un po' io al tuo padrone, quando lo metteranno fuori! Pietromagro passa metà dell'anno in prigione, perché è nato disgraziato e quando c'è un furto nei dintorni finiscono sempre per mettere dentro lui. Torna e vede la montagna di scarpe sfondate e la bottega aperta senza dentro nessuno. Allora si siede al deschetto, piglia una scarpa, la gira, la rigira, la ributta nel mucchio; poi si prende la faccia pelosa tra le mani ossute, e sacramenta. Pin arriva fischiando e ancora non sa niente: ed ecco che si trova davanti Pietromagro con quelle mani già alte nell'aria e quelle pupille incorniciate di giallo e quella faccia nera di barba corta come pelo di cane. Grida, ma Pietromagro l'ha acciuffato e non lo molla; quando è stanco di picchiarlo lo lascia in bottega e s'infila all'osteria. Per quel giorno nessuno lo rivede. La sera, ogni due giorni, dalla sorella di Pin viene il marinaio tedesco. Pin lo aspetta nel carrugio ogni volta mentre sale, per chiedergli una sigaretta; i primi tempi era generoso e ne regalava anche tre, quattro per volta. Prendere in giro il marinaio tedesco è facile perché lui non capisce e guarda con quella faccia quagliata, senza contorno, rasa fin sulle tempie. Poi, quando se n'è andato, gli si possono fare gli sberleffi dietro, sicuri che non si volta; è ridicolo visto di dietro, con quei due nastri neri che gli scendono dal berretto marinaio fino al sedere lasciato scoperto dal giubbetto corto, un sedere carnoso, da donna, con una grossa pistola tedesca poggiata sopra. - Ruffiano... Ruffiano... - dice la gente a Pin dalle finestre, sottovoce perché con quei tipi è meglio non scherzare. - Cornuti... Cornuti... - risponde Pin facendo loro il verso e ingozzandosi di fumo gola e naso, fumo ancora aspro e ruvido contro la sua gola di bambino, ma di cui bisogna ingozzarsi fino a farsi lagrimare gli occhi e tossire con rabbia, non si sa bene il perché. Poi, con la sigaretta in bocca, andare all'osteria e dire: - Mondoboia, chi mi paga un bicchiere gli dico una cosa che poi mi dice grazie. All'osteria ci sono sempre gli stessi, tutt'il giorno, da anni, a gomiti sui tavoli e menti sui pugni che guardano le mosche sull'incerato e l'ombra viola in fondo ai bicchieri. - Che c'è, - dice Miscèl il Francese. - Tua sorella ha ribassato i prezzi? Gli altri ridono e picchiano pugni sullo zinco. - Te la sei presa questa volta, Pin, la risposta! Pin è li che lo guarda di sotto in su attraverso la frangia di capelli spinosi che gli mangia la fronte. - Mondoboia, proprio come pensavo io. Guardate un poco, pensa sempre a mia sorella. Vi dico, non smette mai di pensarci: s'è innamorato. Di mia sorella s'è innamorato, che coraggio... Gli altri ridono a gola spiegata e lo scappellottano e gli versano un bicchiere. Il vino non piace a Pin: è aspro contro la gola e arriccia la pelle e mette addosso una smania di ridere, gridare ed essere cattivi. Pure lo beve, tracanna bicchieri tutto d'un fiato come inghiotte fumo, come alla notte spia con schifo la sorella sul letto insieme a uomini nudi, e il vederla è come una carezza ruvida, sotto la pelle, un gusto aspro, come tutte le cose degli uomini; fumo, vino, donne. - Canta, Pin, - gli dicono. Pin canta bene, serio, impettito, con quella voce di bambino rauco. Canta Le quattro stagioni."
                }
            ];

            const getCommonErrors = () => [
                {
                    title: "API Key Issues",
                    solutions: [
                        "Make sure your API key is correct and not expired",
                        "Check that you're using the right API key from Google AI Studio",
                        "Ensure the API key has proper permissions for Gemini API"
                    ]
                },
                {
                    title: "Network Issues",
                    solutions: [
                        "Check your internet connection",
                        "Try refreshing the page",
                        "Check if your firewall is blocking the request"
                    ]
                },
                {
                    title: "CORS Issues",
                    solutions: [
                        "The app should work fine on Render's domains",
                        "If testing locally, try using a different browser",
                        "Check browser console for CORS errors"
                    ]
                },
                {
                    title: "Rate Limiting",
                    solutions: [
                        "Wait a few minutes before trying again",
                        "Check your Google AI Studio quota usage",
                        "Consider upgrading your API plan if needed"
                    ]
                }
            ];

            if (showIntro) {
                return (
                    <div className="min-h-screen bg-black text-white p-4">
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-4xl font-bold text-center mb-8">Speed Reading Chat</h1>
                            
                            <div className="bg-gray-900 p-6 rounded-lg mb-6">
                                <h2 className="text-2xl font-semibold mb-4">How to Use</h2>
                                <ul className="space-y-2 text-gray-300">
                                    <li>• Enter your Gemini API key in the field below</li>
                                    <li>• Type your message and press Enter to send</li>
                                    <li>• The AI response will be displayed word by word for speed reading</li>
                                    <li>• Adjust the word duration slider to control reading speed</li>
                                    <li>• Choose text alignment (left, center, right)</li>
                                    <li>• Click "Next" to continue to the next sentence</li>
                                </ul>
                            </div>

                            <div className="bg-gray-900 p-6 rounded-lg mb-6">
                                <h3 className="text-xl font-semibold mb-3">Choose Mode</h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div className={`p-4 border-2 rounded-lg cursor-pointer transition-colors ${
                                        isDemoMode ? 'border-blue-500 bg-blue-900/20' : 'border-gray-600 hover:border-gray-500'
                                    }`} onClick={() => setIsDemoMode(true)}>
                                        <h4 className="text-lg font-semibold mb-2">🎯 Demo Mode</h4>
                                        <p className="text-sm text-gray-300">Test the speed reading functionality with sample texts. No API key required.</p>
                                    </div>
                                    
                                    <div className={`p-4 border-2 rounded-lg cursor-pointer transition-colors ${
                                        !isDemoMode ? 'border-blue-500 bg-blue-900/20' : 'border-gray-600 hover:border-gray-500'
                                    }`} onClick={() => setIsDemoMode(false)}>
                                        <h4 className="text-lg font-semibold mb-2">🤖 API Mode</h4>
                                        <p className="text-sm text-gray-300">Use the Gemini LLM API for real conversations. Requires API key.</p>
                                    </div>
                                </div>

                                {isDemoMode ? (
                                    <div className="bg-blue-900/20 p-4 rounded-lg border border-blue-500">
                                        <h4 className="font-semibold mb-3">Demo Mode Active</h4>
                                        <p className="text-sm text-gray-300 mb-3">You can now test the speed reading functionality with sample texts. Just type any message and you'll get a random sample response to practice with.</p>
                                        <div className="text-sm">
                                            <div className="font-semibold mb-2">Sample texts include:</div>
                                            <ul className="space-y-1 text-gray-300">
                                                {getSampleTexts().map((sample, index) => (
                                                    <li key={index}>• {sample.title}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <p className="text-gray-300 mb-4">
                                            Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">Google AI Studio</a>
                                        </p>
                                        <div className="flex gap-2 mb-4">
                                            <input
                                                type="password"
                                                placeholder="YOUR_GEMINI_API_KEY"
                                                value={apiKey}
                                                onChange={(e) => setApiKey(e.target.value)}
                                                className="flex-1 p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400"
                                            />
                                            <button
                                                onClick={testApiConnection}
                                                disabled={!apiKey}
                                                className="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                                            >
                                                Test API
                                            </button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className={`status-indicator status-${apiStatus}`}></span>
                                            <span className="text-sm">
                                                {apiStatus === 'idle' && 'Ready to test'}
                                                {apiStatus === 'loading' && 'Testing connection...'}
                                                {apiStatus === 'success' && 'API connection successful!'}
                                                {apiStatus === 'error' && 'API connection failed'}
                                            </span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="text-center">
                                <button
                                    onClick={() => setShowIntro(false)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                >
                                    Start Chatting
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-black text-white p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold">Speed Reading Chat</h1>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowDebug(!showDebug)}
                                    className="text-gray-400 hover:text-white px-3 py-1 rounded border border-gray-600"
                                >
                                    {showDebug ? 'Hide' : 'Show'} Debug
                                </button>
                                <button
                                    onClick={() => setShowIntro(true)}
                                    className="text-gray-400 hover:text-white"
                                >
                                    Help
                                </button>
                            </div>
                        </div>

                        {/* Debug Panel */}
                        {showDebug && (
                            <div className="bg-gray-900 p-4 rounded-lg mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Debug Panel</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={testApiConnection}
                                            className="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded"
                                        >
                                            Test API
                                        </button>
                                        <button
                                            onClick={clearDebugLog}
                                            className="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded"
                                        >
                                            Clear Log
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <h4 className="font-semibold mb-2">Debug Log</h4>
                                        <div className="debug-panel bg-gray-800 p-3 rounded text-xs">
                                            {debugLog.map((log, index) => (
                                                <div key={index} className={`mb-1 ${
                                                    log.type === 'error' ? 'text-red-400' :
                                                    log.type === 'success' ? 'text-green-400' :
                                                    'text-gray-300'
                                                }`}>
                                                    [{log.timestamp}] {log.message}
                                                </div>
                                            ))}
                                            {debugLog.length === 0 && (
                                                <div className="text-gray-500">No debug messages yet</div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-semibold mb-2">API Status</h4>
                                        <div className="space-y-2">
                                            <div className="flex items-center gap-2">
                                                <span className={`status-indicator status-${apiStatus}`}></span>
                                                <span className="text-sm">Status: {apiStatus}</span>
                                            </div>
                                            
                                            {lastApiError && (
                                                <div className="bg-red-900 p-3 rounded text-xs">
                                                    <div className="font-semibold text-red-300 mb-1">Last Error:</div>
                                                    <pre className="whitespace-pre-wrap">{JSON.stringify(lastApiError, null, 2)}</pre>
                                                </div>
                                            )}
                                            
                                            {lastApiResponse && (
                                                <div className="bg-green-900 p-3 rounded text-xs">
                                                    <div className="font-semibold text-green-300 mb-1">Last Response:</div>
                                                    <pre className="whitespace-pre-wrap">{JSON.stringify(lastApiResponse, null, 2)}</pre>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="mt-4">
                                    <h4 className="font-semibold mb-2">Common Issues & Solutions</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {getCommonErrors().map((error, index) => (
                                            <div key={index} className="bg-gray-800 p-3 rounded">
                                                <div className="font-semibold text-yellow-400 mb-2">{error.title}</div>
                                                <ul className="text-xs space-y-1">
                                                    {error.solutions.map((solution, solIndex) => (
                                                        <li key={solIndex} className="text-gray-300">• {solution}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Word Display Area */}
                        {isReading && (
                            <div className={`bg-gray-900 p-8 rounded-lg mb-6 min-h-[200px] flex items-center justify-${alignment === 'left' ? 'start' : alignment === 'right' ? 'end' : 'center'}`}>
                                <div className={`word-display ${alignment === 'left' ? 'text-left' : alignment === 'right' ? 'text-right' : 'text-center'}`}>
                                    {currentWord ? (
                                        <span dangerouslySetInnerHTML={{ __html: applyFixation(currentWord) }} />
                                    ) : (
                                        <span>Loading...</span>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Controls */}
                        <div className="bg-gray-900 p-4 rounded-lg mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Text Alignment</label>
                                    <select
                                        value={alignment}
                                        onChange={(e) => setAlignment(e.target.value)}
                                        className="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white"
                                    >
                                        <option value="left">Left</option>
                                        <option value="center">Center</option>
                                        <option value="right">Right</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium mb-2">Base Speed: {wordDuration}ms (per 5 chars)</label>
                                    <input
                                        type="range"
                                        min="100"
                                        max="1000"
                                        value={wordDuration}
                                        onChange={(e) => setWordDuration(parseInt(e.target.value))}
                                        className="w-full"
                                    />
                                    <div className="text-xs text-gray-400 mt-1">
                                        Duration = (word length × {wordDuration/5}ms) + punctuation pause
                                    </div>
                                </div>
                                </div>
                                
                                {isReading && (
                                <div className="flex flex-wrap gap-2 justify-center">
                                    <button
                                        onClick={handleRewindPhrase}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition-colors"
                                    >
                                        ⏮️ Rewind Phrase
                                    </button>
                                    <button
                                        onClick={handleRewindWords}
                                        className="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded transition-colors"
                                    >
                                        ⏪ Rewind 5 Words
                                    </button>
                                        <button
                                            onClick={handleNextSentence}
                                            className="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition-colors"
                                        >
                                        ⏭️ Next Sentence
                                        </button>
                                    </div>
                                )}
                        </div>

                        {/* Chat Input */}
                        <div className="bg-gray-900 p-4 rounded-lg mb-6">
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    placeholder={isDemoMode ? "Type anything to get a sample text..." : "Type your message..."}
                                    disabled={isLoading}
                                    className="flex-1 p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 disabled:opacity-50"
                                />
                                <button
                                    onClick={sendMessage}
                                    disabled={isLoading || !message.trim() || (!isDemoMode && !apiKey)}
                                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                >
                                    {isLoading ? 'Sending...' : 'Send'}
                                </button>
                            </div>
                            {isDemoMode && (
                                <div className="mt-2 text-sm text-gray-400">
                                    🎯 Demo mode: You'll get random sample texts to practice speed reading
                                </div>
                            )}
                        </div>

                        {/* Chat History */}
                        <div className="bg-gray-900 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold mb-4">Chat History</h3>
                            <div ref={chatContainerRef} className="chat-container">
                                {chatHistory.map((msg, index) => (
                                    <div
                                        key={index}
                                        className={`chat-message ${
                                            msg.role === 'user' ? 'user-message' : 
                                            msg.content.startsWith('Error:') ? 'error-message' : 'assistant-message'
                                        }`}
                                    >
                                        <div className="font-semibold mb-1">
                                            {msg.role === 'user' ? 'You' : 'Assistant'}
                                        </div>
                                        <div className="whitespace-pre-wrap">{msg.content}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <SpeedReadingChat />
            </ErrorBoundary>
        );
    </script>
</body>
</html> 