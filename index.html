<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Reading Chat - Dante's Inferno (v2)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        
        .word-display {
            font-size: 2.5rem;
            line-height: 1.2;
            font-family: 'Arial', sans-serif;
        }
        
        .word-display strong {
            font-weight: 900;
            color: #ffffff;
        }
        
        @media (max-width: 768px) {
            .word-display {
                font-size: 1.5rem;
            }
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        
        .user-message {
            background-color: #374151;
            margin-left: 2rem;
        }
        
        .assistant-message {
            background-color: #1f2937;
            margin-right: 2rem;
        }
        
        .error-message {
            background-color: #7f1d1d;
            border-left: 4px solid #ef4444;
        }
        
        .debug-panel {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-loading { background-color: #f59e0b; }
        .status-idle { background-color: #6b7280; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function SpeedReadingChat() {
            const [apiKey, setApiKey] = useState('');
            const [message, setMessage] = useState('');
            const [chatHistory, setChatHistory] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [currentWord, setCurrentWord] = useState('');
            const [wordIndex, setWordIndex] = useState(0);
            const [currentSentence, setCurrentSentence] = useState([]);
            const [sentenceIndex, setSentenceIndex] = useState(0);
            const [isReading, setIsReading] = useState(false);
            const [alignment, setAlignment] = useState('center');
            const [wordDuration, setWordDuration] = useState(500);
            const [showIntro, setShowIntro] = useState(false);
            const [showDebug, setShowDebug] = useState(false);
            const [debugLog, setDebugLog] = useState([]);
            const [apiStatus, setApiStatus] = useState('idle');
            const [lastApiResponse, setLastApiResponse] = useState(null);
            const [lastApiError, setLastApiError] = useState(null);
            const [isDemoMode, setIsDemoMode] = useState(true);
            const [demoText, setDemoText] = useState('');
            
            const wordTimeoutRef = useRef(null);
            const chatContainerRef = useRef(null);

            const addDebugLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setDebugLog(prev => [...prev, { timestamp, message, type }]);
            };

            const testApiConnection = async () => {
                if (!apiKey) {
                    addDebugLog('No API key provided', 'error');
                    return false;
                }

                setApiStatus('loading');
                addDebugLog('Testing API connection...', 'info');

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: 'Hello'
                                }]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok && data.candidates) {
                        setApiStatus('success');
                        addDebugLog('API connection successful', 'success');
                        setLastApiResponse(data);
                        return true;
                    } else {
                        setApiStatus('error');
                        setLastApiError(data);
                        addDebugLog(`API Error: ${data.error?.message || 'Unknown error'}`, 'error');
                        return false;
                    }
                } catch (error) {
                    setApiStatus('error');
                    setLastApiError({ error: { message: error.message } });
                    addDebugLog(`Network Error: ${error.message}`, 'error');
                    return false;
                }
            };

            const calculateWordDuration = (word) => {
                const baseDuration = 200;
                const extraDuration = Math.max(0, word.length - 3) * 50;
                const calculatedDuration = baseDuration + extraDuration;
                
                // Add extra pause for punctuation
                let punctuationPause = 0;
                if (word.match(/[.!?;,:'"()]/)) {
                    punctuationPause = 300; // 300ms extra for punctuation
                } else if (word.match(/[,;]/)) {
                    punctuationPause = 150; // 150ms extra for commas and semicolons
                }
                
                return Math.max(calculatedDuration + punctuationPause, wordDuration);
            };

            const applyFixation = (word) => {
                const length = word.length;
                let boldCount = 0;
                
                if (length <= 3) {
                    boldCount = 1;
                } else if (length === 4) {
                    boldCount = 2;
                } else {
                    boldCount = Math.ceil(length * 0.4); // 40% of letters
                }
                
                // Calculate which letters to bold (center-weighted)
                const startIndex = Math.floor((length - boldCount) / 2);
                const boldIndices = [];
                
                for (let i = 0; i < boldCount; i++) {
                    boldIndices.push(startIndex + i);
                }
                
                // Apply bold formatting
                let result = '';
                for (let i = 0; i < length; i++) {
                    if (boldIndices.includes(i)) {
                        result += `<strong>${word[i]}</strong>`;
                    } else {
                        result += word[i];
                    }
                }
                
                return result;
            };

            const displayNextWord = () => {
                if (currentSentence.length > 0 && sentenceIndex < currentSentence.length) {
                    const currentSentenceText = currentSentence[sentenceIndex];
                    const words = currentSentenceText.split(/\s+/).filter(word => word.trim());
                    
                    if (wordIndex < words.length) {
                        const word = words[wordIndex];
                        setCurrentWord(word);
                        const duration = calculateWordDuration(word);
                        
                        wordTimeoutRef.current = setTimeout(() => {
                            setWordIndex(prev => prev + 1);
                        }, duration);
                    } else {
                        // Move to next sentence
                        setSentenceIndex(prev => prev + 1);
                        setWordIndex(0);
                        if (sentenceIndex + 1 >= currentSentence.length) {
                            setIsReading(false);
                            setCurrentWord('');
                            setSentenceIndex(0);
                            setWordIndex(0);
                        }
                    }
                } else {
                    setIsReading(false);
                    setCurrentWord('');
                    setSentenceIndex(0);
                    setWordIndex(0);
                }
            };

            useEffect(() => {
                if (isReading && currentSentence.length > 0) {
                    displayNextWord();
                }
                
                return () => {
                    if (wordTimeoutRef.current) {
                        clearTimeout(wordTimeoutRef.current);
                    }
                };
            }, [isReading, wordIndex, sentenceIndex, currentSentence, wordDuration]);

            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [chatHistory]);

            // Auto-start with Dante text when component loads
            useEffect(() => {
                const startDanteReading = () => {
                    const sampleTexts = getSampleTexts();
                    const danteText = sampleTexts[0].text;
                    
                    // Split into sentences for speed reading
                    const sentences = danteText.split(/[.!?]+/).filter(s => s.trim());
                    setCurrentSentence(sentences);
                    setSentenceIndex(0);
                    setIsReading(true);
                    addDebugLog(`Started reading Dante's Inferno - ${sentences.length} sentences`, 'success');
                };

                // Start reading after component mount
                const timer = setTimeout(() => {
                    startDanteReading();
                }, 1000);
                return () => clearTimeout(timer);
            }, []);

            const sendMessage = async () => {
                if (!message.trim()) {
                    addDebugLog('Message is empty', 'error');
                    return;
                }
                
                const userMessage = { role: 'user', content: message };
                setChatHistory(prev => [...prev, userMessage]);
                setMessage('');
                setIsLoading(true);
                addDebugLog(`Sending message: "${message.substring(0, 50)}${message.length > 50 ? '...' : ''}"`, 'info');

                if (isDemoMode) {
                    // Demo mode - use sample text
                    setTimeout(() => {
                        const sampleTexts = getSampleTexts();
                        const randomText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                        const assistantMessage = { role: 'assistant', content: randomText.text };
                        setChatHistory(prev => [...prev, assistantMessage]);
                        setApiStatus('success');
                        
                        addDebugLog(`Demo response: ${randomText.title}`, 'success');
                        
                        // Split response into sentences for speed reading
                        const sentences = randomText.text.split(/[.!?]+/).filter(s => s.trim());
                        setCurrentSentence(sentences);
                        setSentenceIndex(0);
                        setIsReading(true);
                        addDebugLog(`Split into ${sentences.length} sentences for speed reading`, 'info');
                        setIsLoading(false);
                    }, 1000); // Simulate API delay
                } else {
                    // API mode
                    if (!apiKey) {
                        addDebugLog('API key missing', 'error');
                        setIsLoading(false);
                        return;
                    }
                    
                    setApiStatus('loading');
                    
                    try {
                        const requestBody = {
                            contents: [{
                                parts: [{
                                    text: message
                                }]
                            }]
                        };

                        addDebugLog(`Request URL: https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent`, 'info');
                        addDebugLog(`Request body: ${JSON.stringify(requestBody, null, 2)}`, 'info');

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });

                        addDebugLog(`Response status: ${response.status} ${response.statusText}`, 'info');

                        const data = await response.json();
                        setLastApiResponse(data);
                        
                        if (response.ok && data.candidates && data.candidates[0] && data.candidates[0].content) {
                            const assistantResponse = data.candidates[0].content.parts[0].text;
                            const assistantMessage = { role: 'assistant', content: assistantResponse };
                            setChatHistory(prev => [...prev, assistantMessage]);
                            setApiStatus('success');
                            
                            addDebugLog(`Response received: ${assistantResponse.substring(0, 100)}${assistantResponse.length > 100 ? '...' : ''}`, 'success');
                            
                            // Split response into sentences for speed reading
                            const sentences = assistantResponse.split(/[.!?]+/).filter(s => s.trim());
                            setCurrentSentence(sentences);
                            setSentenceIndex(0);
                            setIsReading(true);
                            addDebugLog(`Split into ${sentences.length} sentences for speed reading`, 'info');
                        } else {
                            setApiStatus('error');
                            setLastApiError(data);
                            const errorMsg = data.error?.message || 'Invalid response from API';
                            addDebugLog(`API Error: ${errorMsg}`, 'error');
                            addDebugLog(`Full error response: ${JSON.stringify(data, null, 2)}`, 'error');
                            
                            const errorMessage = { role: 'assistant', content: `Error: ${errorMsg}. Please check your API key and try again.` };
                            setChatHistory(prev => [...prev, errorMessage]);
                        }
                    } catch (error) {
                        setApiStatus('error');
                        setLastApiError({ error: { message: error.message } });
                        addDebugLog(`Network Error: ${error.message}`, 'error');
                        addDebugLog(`Error stack: ${error.stack}`, 'error');
                        
                        const errorMessage = { role: 'assistant', content: `Network Error: ${error.message}. Please check your internet connection and try again.` };
                        setChatHistory(prev => [...prev, errorMessage]);
                    } finally {
                        setIsLoading(false);
                    }
                }
            };

            const handleNextSentence = () => {
                if (sentenceIndex < currentSentence.length - 1) {
                    setSentenceIndex(prev => prev + 1);
                    setWordIndex(0);
                    setIsReading(true);
                    addDebugLog(`Moving to sentence ${sentenceIndex + 2}/${currentSentence.length}`, 'info');
                } else {
                    setCurrentSentence([]);
                    setSentenceIndex(0);
                    setWordIndex(0);
                    setIsReading(false);
                    addDebugLog('Finished reading all sentences', 'info');
                }
            };

            const handleRewindPhrase = () => {
                setSentenceIndex(0);
                setWordIndex(0);
                setIsReading(true);
                addDebugLog('Rewound to beginning of phrase', 'info');
            };

            const handleRewindWords = () => {
                const newWordIndex = Math.max(0, wordIndex - 5);
                setWordIndex(newWordIndex);
                setIsReading(true);
                addDebugLog(`Rewound 5 words to word ${newWordIndex}`, 'info');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const clearDebugLog = () => {
                setDebugLog([]);
                addDebugLog('Debug log cleared', 'info');
            };

            const getSampleTexts = () => [
                {
                    title: "Dante's Inferno",
                    text: "Nel mezzo del cammin di nostra vita mi ritrovai per una selva oscura, ché la diritta via era smarrita. Ahi quanto a dir qual era è cosa dura esta selva selvaggia e aspra e forte che nel pensier rinova la paura! Tant' è amara che poco è più morte; ma per trattar del ben ch'i' vi trovai, dirò de l'altre cose ch'i' v'ho scorte. Io non so ben ridir com' i' v'intrai, tant' era pien di sonno a quel punto che la verace via abbandonai. Ma poi ch'i' fui al piè d'un colle giunto, là dove terminava quella valle che m'avea di paura il cor compunto, guardai in alto e vidi le sue spalle vestite già de' raggi del pianeta che mena dritto altrui per ogne calle. Allor fu la paura un poco queta, che nel lago del cor m'era durata la notte ch'i' passai con tanta pieta. E come quei che con lena affannata, uscito fuor del pelago a la riva, si volge a l'acqua perigliosa e guata, così l'animo mio, ch'ancor fuggiva, si volse a retro a rimirar lo passo che non lasciò già mai persona viva. Poi ch'èi posato un poco il corpo lasso, ripresi via per la piaggia diserta, sì che 'l piè fermo sempre era 'l più basso. Ed ecco, quasi al cominciar de l'erta, una lonza leggera e presta molto, che di pel macolato era coverta; e non mi si partia dinanzi al volto, anzi 'mpediva tanto il mio cammino, ch'i' fui per ritornar più volte vòlto. Temp' era dal principio del mattino, e 'l sol montava 'n sù con quelle stelle ch'eran con lui quando l'amor divino mosse di prima quelle cose belle; sì ch'a bene sperar m'era cagione di quella fiera a la gaetta pelle l'ora del tempo e la dolce stagione; ma non sì che paura non mi desse la vista che m'apparve d'un leone. Questi parea che contra me venisse con la test' alta e con rabbiosa fame, sì che parea che l'aere ne tremesse. Ed una lupa, che di tutte brame sembiava carca ne la sua magrezza, e molte genti fé già viver grame, questa mi porse tanto di gravezza con la paura ch'uscia di sua vista, ch'io perdei la speranza de l'altezza. E qual è quei che volontieri acquista, e giugne 'l tempo che perder lo face, che 'n tutti suoi pensier piange e s'attrista; tal mi fece la bestia sanza pace, che, venendomi 'ncontro, a poco a poco mi ripigneva là dove 'l sol tace. Mentre ch'i' rovinava in basso loco, dinanzi a li occhi mi si fu offerto chi per lungo silenzio parea fioco. Quando vidi costui nel gran deserto, «Miserere di me», gridai a lui, «qual che tu sii, od ombra od omo certo!». Rispuosemi: «Non omo, omo già fui, e li parenti miei furon lombardi, mantoani per patrïa ambedui. Nacqui sub Iulio, ancor che fosse tardi, e vissi a Roma sotto 'l buono Augusto nel tempo de li dèi falsi e bugiardi. Poeta fui, e cantai di quel giusto figliuol d'Anchise che venne di Troia, poi che 'l superbo Ilïón fu combusto. Ma tu perché ritorni a tanta noia? perché non sali il dilettoso monte ch'è principio e cagion di tutta gioia?». «Or se' tu quel Virgilio e quella fonte che spandi di parlar sì largo fiume?», rispuos' io lui con vergognosa fronte. «O de li altri poeti onore e lume, vagliami 'l lungo studio e 'l grande amore che m'ha fatto cercar lo tuo volume. Tu se' lo mio maestro e 'l mio autore, tu se' solo colui da cu' io tolsi lo bello stilo che m'ha fatto onore. Vedi la bestia per cu' io mi volsi; aiutami da lei, famoso saggio, ch'ella mi fa tremar le vene e i polsi». «A te convien tenere altro vïaggio», rispuose, poi che lagrimar mi vide, «se vuo' campar d'esto loco selvaggio; ché questa bestia, per la qual tu gride, non lascia altrui passar per la sua via, ma tanto lo 'mpedisce che l'uccide; e ha natura sì malvagia e ria, che mai non empie la bramosa voglia, e dopo 'l pasto ha più fame che pria. Molti son li animali a cui s'ammoglia, e più saranno ancora, infin che 'l veltro verrà, che la farà morir con doglia. Questi non ciberà terra né peltro, ma sapïenza, amore e virtute, e sua nazion sarà tra feltro e feltro. Di quella umile Italia fia salute per cui morì la vergine Cammilla, Eurialo e Turno e Niso di ferute. Questi la caccerà per ogne villa, fin che l'avrà rimessa ne lo 'nferno, là onde 'nvidia prima dipartilla. Ond' io per lo tuo me' penso e discerno che tu mi segui, e io sarò tua guida, e trarrotti di qui per loco etterno; ove udirai le disperate strida, vedrai li antichi spiriti dolenti, ch'a la seconda morte ciascun grida; e vederai color che son contenti nel foco, perché speran di venire quando che sia a le beate genti. A le quai poi se tu vorrai salire, anima fia a ciò più di me degna: con lei ti lascerò nel mio partire; ché quello imperador che là sù regna, perch' i' fu' ribellante a la sua legge, non vuol che 'n sua città per me si vegna. In tutte parti impera e quivi regge; quivi è la sua città e l'alto seggio: oh felice colui cu' ivi elegge!». E io a lui: «Poeta, io ti richeggio per quello Dio che tu non conoscesti, acciò ch'io fugga questo male e peggio, che tu mi meni là dov' or dicesti, sì ch'io veggia la porta di san Pietro e color cui tu fai cotanto mesti». Allor si mosse, e io li tenni dietro. Inferno Canto II Lo giorno se n'andava, e l'aere bruno toglieva li animai che sono in terra da le fatiche loro; e io sol uno m'apparecchiava a sostener la guerra sì del cammino e sì de la pietate, che ritrarrà la mente che non erra. O muse, o alto ingegno, or m'aiutate; o mente che scrivesti ciò ch'io vidi, qui si parrà la tua nobilitate. Io cominciai: «Poeta che mi guidi, guarda la mia virtù s'ell' è possente, prima ch'a l'alto passo tu mi fidi. Tu dici che di Silvïo il parente, corruttibile ancora, ad immortale secolo andò, e fu sensibilmente. Però, se l'avversario d'ogne male cortese i fu, pensando l'alto effetto ch'uscir dovea di lui, e 'l chi e 'l quale non pare indegno ad omo d'intelletto; ch'e' fu de l'alma Roma e di suo impero ne l'empireo ciel per padre eletto: la quale e 'l quale, a voler dir lo vero, fu stabilita per lo loco santo u' siede il successor del maggior Piero. Per quest' andata onde li dai tu vanto, intese cose che furon cagione di sua vittoria e del papale ammanto. Andovvi poi lo Vas d'elezïone, per recarne conforto a quella fede ch'è principio a la via di salvazione. Ma io, perché venirvi? o chi 'l concede? Io non Enëa, io non Paulo sono; me degno a ciò né io né altri 'l crede. Per che, se del venire io m'abbandono, temo che la venuta non sia folle. Se' savio; intendi me' ch'i' non ragiono». E qual è quei che disvuol ciò che volle e per novi pensier cangia proposta, sì che dal cominciar tutto si tolle, tal mi fec' ïo 'n quella oscura costa, perché, pensando, consumai la 'mpresa che fu nel cominciar cotanto tosta. «S'i' ho ben la parola tua intesa», rispuose del magnanimo quell' ombra, «l'anima tua è da viltade offesa; la qual molte fïate l'omo ingombra sì che d'onrata impresa lo rivolve, come falso veder bestia quand' ombra. Da questa tema acciò che tu ti solve, dirottiperch' io venni e quel ch'io 'ntesi nel primo punto che di te mi dolve. Io era tra color che son sospesi, e donna mi chiamò beata e bella, tal che di comandare io la richiesi. Lucevan li occhi suoi più che la stella; e cominciommi a dir soave e piana, con angelica voce, in sua favella: \"O anima cortese mantoana, di cui la fama ancor nel mondo dura, e durerà quanto 'l mondo lontana, l'amico mio, e non de la ventura, ne la diserta piaggia è impedito sì nel cammin, che vòlt' è per paura; e temo che non sia già sì smarrito, ch'io mi sia tardi al soccorso levata, per quel ch'i' ho di lui nel cielo udito. Or movi, e con la tua parola ornata e con ciò c'ha mestieri al suo campare, l'aiuta sì ch'i' ne sia consolata. I' son Beatrice che ti faccio andare; vegno del loco ove tornar disio; amor mi mosse, che mi fa parlare. Quando sarò dinanzi al segnor mio, di te mi loderò sovente a lui\". Tacette allora, e poi comincia' io: \"O donna di virtù sola per cui l'umana spezie eccede ogne contento di quel ciel c'ha minor li cerchi sui, tanto m'aggrada il tuo comandamento, che l'ubidir, se già fosse, m'è tardi; più non t'è uo' ch'aprirmi il tuo talento. Ma dimmi la cagion che non ti guardi de lo scender qua giuso in questo centro de l'ampio loco ove tornar tu ardi\". \"Da che tu vuo' saver cotanto a dentro, dirottibrievemente\", mi rispuose, \"perch' i' non temo di venir qua entro. Temer si dee di sole quelle cose c'hanno potenza di fare altrui male; de l'altre no, ché non son paurose. I' son fatta da Dio, sua mercé, tale, che la vostra miseria non mi tange, né fiamma d'esto 'ncendio non m'assale. Donna è gentil nel ciel che si compiange di questo 'mpedimento ov' io ti mando, sì che duro giudicio là sù frange. Questa chiese Lucia in suo dimando e disse:—Or ha bisogno il tuo fedele di te, e io a te lo raccomando—. Lucia, nimica di ciascun crudele, si mosse, e venne al loco dov' i' era, che mi sedea con l'antica Rachele. Disse:—Beatrice, loda di Dio vera, ché non soccorri quei che t'amò tanto, ch'uscì per te de la volgare schiera? Non odi tu la pieta del suo pianto, non vedi tu la morte che 'l combatte su la fiumana ove 'l mar non ha vanto?—. Al mondo non fur mai persone ratte a far lor pro o a fuggir lor danno, com' io, dopo cotai parole fatte, venni qua giù del mio beato scanno, fidandomi del tuo parlare onesto, ch'onora te e quei ch'udito l'hanno\". Poscia che m'ebbe ragionato questo, li occhi lucenti lagrimando volse, per che mi fece del venir più presto. E venni a te così com' ella volse: d'inanzi a quella fiera ti levai che del bel monte il corto andar ti tolse. Dunque: che è? perché, perché restai, perché tanta viltà nel core allette, perché ardire e franchezza non hai, poscia che tai tre donne benedette curan di te ne la corte del cielo, e 'l mio parlar tanto ben ti promette?». Quali fioretti dal notturno gelo chinati e chiusi, poi che 'l sol li 'mbianca, si drizzan tutti aperti in loro stelo, tal mi fec' io di mia virtude stanca, e tanto buono ardire al cor mi corse, ch'i' cominciai come persona franca: «Oh pietosa colei che mi soccorse! e te cortese ch'ubidisti tosto a le vere parole che ti porse! Tu m'hai con disiderio il cor disposto sì al venir con le parole tue, ch'i' son tornato nel primo proposto. Or va, ch'un sol volere è d'ambedue: tu duca, tu segnore e tu maestro». Così li dissi; e poi che mosso fue, intrai per lo cammino alto e silvestro."
                }
            ];

            const getCommonErrors = () => [
                {
                    title: "API Key Issues",
                    solutions: [
                        "Make sure your API key is correct and not expired",
                        "Check that you're using the right API key from Google AI Studio",
                        "Ensure the API key has proper permissions for Gemini API"
                    ]
                },
                {
                    title: "Network Issues",
                    solutions: [
                        "Check your internet connection",
                        "Try refreshing the page",
                        "Check if your firewall is blocking the request"
                    ]
                },
                {
                    title: "CORS Issues",
                    solutions: [
                        "The app should work fine on Render's domains",
                        "If testing locally, try using a different browser",
                        "Check browser console for CORS errors"
                    ]
                },
                {
                    title: "Rate Limiting",
                    solutions: [
                        "Wait a few minutes before trying again",
                        "Check your Google AI Studio quota usage",
                        "Consider upgrading your API plan if needed"
                    ]
                }
            ];

            if (showIntro) {
                return (
                    <div className="min-h-screen bg-black text-white p-4">
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-4xl font-bold text-center mb-8">Speed Reading Chat</h1>
                            
                            <div className="bg-gray-900 p-6 rounded-lg mb-6">
                                <h2 className="text-2xl font-semibold mb-4">How to Use</h2>
                                <ul className="space-y-2 text-gray-300">
                                    <li>• Enter your Gemini API key in the field below</li>
                                    <li>• Type your message and press Enter to send</li>
                                    <li>• The AI response will be displayed word by word for speed reading</li>
                                    <li>• Adjust the word duration slider to control reading speed</li>
                                    <li>• Choose text alignment (left, center, right)</li>
                                    <li>• Click "Next" to continue to the next sentence</li>
                                </ul>
                            </div>

                            <div className="bg-gray-900 p-6 rounded-lg mb-6">
                                <h3 className="text-xl font-semibold mb-3">Choose Mode</h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div className={`p-4 border-2 rounded-lg cursor-pointer transition-colors ${
                                        isDemoMode ? 'border-blue-500 bg-blue-900/20' : 'border-gray-600 hover:border-gray-500'
                                    }`} onClick={() => setIsDemoMode(true)}>
                                        <h4 className="text-lg font-semibold mb-2">🎯 Demo Mode</h4>
                                        <p className="text-sm text-gray-300">Test the speed reading functionality with sample texts. No API key required.</p>
                                    </div>
                                    
                                    <div className={`p-4 border-2 rounded-lg cursor-pointer transition-colors ${
                                        !isDemoMode ? 'border-blue-500 bg-blue-900/20' : 'border-gray-600 hover:border-gray-500'
                                    }`} onClick={() => setIsDemoMode(false)}>
                                        <h4 className="text-lg font-semibold mb-2">🤖 API Mode</h4>
                                        <p className="text-sm text-gray-300">Use the Gemini LLM API for real conversations. Requires API key.</p>
                                    </div>
                                </div>

                                {isDemoMode ? (
                                    <div className="bg-blue-900/20 p-4 rounded-lg border border-blue-500">
                                        <h4 className="font-semibold mb-3">Demo Mode Active</h4>
                                        <p className="text-sm text-gray-300 mb-3">You can now test the speed reading functionality with sample texts. Just type any message and you'll get a random sample response to practice with.</p>
                                        <div className="text-sm">
                                            <div className="font-semibold mb-2">Sample texts include:</div>
                                            <ul className="space-y-1 text-gray-300">
                                                {getSampleTexts().map((sample, index) => (
                                                    <li key={index}>• {sample.title}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <p className="text-gray-300 mb-4">
                                            Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">Google AI Studio</a>
                                        </p>
                                        <div className="flex gap-2 mb-4">
                                            <input
                                                type="password"
                                                placeholder="YOUR_GEMINI_API_KEY"
                                                value={apiKey}
                                                onChange={(e) => setApiKey(e.target.value)}
                                                className="flex-1 p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400"
                                            />
                                            <button
                                                onClick={testApiConnection}
                                                disabled={!apiKey}
                                                className="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                                            >
                                                Test API
                                            </button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className={`status-indicator status-${apiStatus}`}></span>
                                            <span className="text-sm">
                                                {apiStatus === 'idle' && 'Ready to test'}
                                                {apiStatus === 'loading' && 'Testing connection...'}
                                                {apiStatus === 'success' && 'API connection successful!'}
                                                {apiStatus === 'error' && 'API connection failed'}
                                            </span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="text-center">
                                <button
                                    onClick={() => setShowIntro(false)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                >
                                    Start Chatting
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-black text-white p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-2xl font-bold">Speed Reading Chat</h1>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowDebug(!showDebug)}
                                    className="text-gray-400 hover:text-white px-3 py-1 rounded border border-gray-600"
                                >
                                    {showDebug ? 'Hide' : 'Show'} Debug
                                </button>
                                <button
                                    onClick={() => setShowIntro(true)}
                                    className="text-gray-400 hover:text-white"
                                >
                                    Help
                                </button>
                            </div>
                        </div>

                        {/* Debug Panel */}
                        {showDebug && (
                            <div className="bg-gray-900 p-4 rounded-lg mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Debug Panel</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={testApiConnection}
                                            className="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded"
                                        >
                                            Test API
                                        </button>
                                        <button
                                            onClick={clearDebugLog}
                                            className="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded"
                                        >
                                            Clear Log
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <h4 className="font-semibold mb-2">Debug Log</h4>
                                        <div className="debug-panel bg-gray-800 p-3 rounded text-xs">
                                            {debugLog.map((log, index) => (
                                                <div key={index} className={`mb-1 ${
                                                    log.type === 'error' ? 'text-red-400' :
                                                    log.type === 'success' ? 'text-green-400' :
                                                    'text-gray-300'
                                                }`}>
                                                    [{log.timestamp}] {log.message}
                                                </div>
                                            ))}
                                            {debugLog.length === 0 && (
                                                <div className="text-gray-500">No debug messages yet</div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-semibold mb-2">API Status</h4>
                                        <div className="space-y-2">
                                            <div className="flex items-center gap-2">
                                                <span className={`status-indicator status-${apiStatus}`}></span>
                                                <span className="text-sm">Status: {apiStatus}</span>
                                            </div>
                                            
                                            {lastApiError && (
                                                <div className="bg-red-900 p-3 rounded text-xs">
                                                    <div className="font-semibold text-red-300 mb-1">Last Error:</div>
                                                    <pre className="whitespace-pre-wrap">{JSON.stringify(lastApiError, null, 2)}</pre>
                                                </div>
                                            )}
                                            
                                            {lastApiResponse && (
                                                <div className="bg-green-900 p-3 rounded text-xs">
                                                    <div className="font-semibold text-green-300 mb-1">Last Response:</div>
                                                    <pre className="whitespace-pre-wrap">{JSON.stringify(lastApiResponse, null, 2)}</pre>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="mt-4">
                                    <h4 className="font-semibold mb-2">Common Issues & Solutions</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {getCommonErrors().map((error, index) => (
                                            <div key={index} className="bg-gray-800 p-3 rounded">
                                                <div className="font-semibold text-yellow-400 mb-2">{error.title}</div>
                                                <ul className="text-xs space-y-1">
                                                    {error.solutions.map((solution, solIndex) => (
                                                        <li key={solIndex} className="text-gray-300">• {solution}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Word Display Area */}
                        {isReading && (
                            <div className={`bg-gray-900 p-8 rounded-lg mb-6 min-h-[200px] flex items-center justify-${alignment === 'left' ? 'start' : alignment === 'right' ? 'end' : 'center'}`}>
                                <div className={`word-display ${alignment === 'left' ? 'text-left' : alignment === 'right' ? 'text-right' : 'text-center'}`}>
                                    <span dangerouslySetInnerHTML={{ __html: applyFixation(currentWord) }} />
                                </div>
                            </div>
                        )}

                        {/* Controls */}
                        <div className="bg-gray-900 p-4 rounded-lg mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Text Alignment</label>
                                    <select
                                        value={alignment}
                                        onChange={(e) => setAlignment(e.target.value)}
                                        className="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white"
                                    >
                                        <option value="left">Left</option>
                                        <option value="center">Center</option>
                                        <option value="right">Right</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium mb-2">Word Duration: {wordDuration}ms</label>
                                    <input
                                        type="range"
                                        min="100"
                                        max="1000"
                                        value={wordDuration}
                                        onChange={(e) => setWordDuration(parseInt(e.target.value))}
                                        className="w-full"
                                    />
                                </div>
                            </div>
                            
                            {isReading && (
                                <div className="flex flex-wrap gap-2 justify-center">
                                    <button
                                        onClick={handleRewindPhrase}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition-colors"
                                    >
                                        ⏮️ Rewind Phrase
                                    </button>
                                    <button
                                        onClick={handleRewindWords}
                                        className="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded transition-colors"
                                    >
                                        ⏪ Rewind 5 Words
                                    </button>
                                    <button
                                        onClick={handleNextSentence}
                                        className="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition-colors"
                                    >
                                        ⏭️ Next Sentence
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Chat Input */}
                        <div className="bg-gray-900 p-4 rounded-lg mb-6">
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    placeholder={isDemoMode ? "Type anything to get a sample text..." : "Type your message..."}
                                    disabled={isLoading}
                                    className="flex-1 p-3 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 disabled:opacity-50"
                                />
                                <button
                                    onClick={sendMessage}
                                    disabled={isLoading || !message.trim() || (!isDemoMode && !apiKey)}
                                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                >
                                    {isLoading ? 'Sending...' : 'Send'}
                                </button>
                            </div>
                            {isDemoMode && (
                                <div className="mt-2 text-sm text-gray-400">
                                    🎯 Demo mode: You'll get random sample texts to practice speed reading
                                </div>
                            )}
                        </div>

                        {/* Chat History */}
                        <div className="bg-gray-900 p-4 rounded-lg">
                            <h3 className="text-lg font-semibold mb-4">Chat History</h3>
                            <div ref={chatContainerRef} className="chat-container">
                                {chatHistory.map((msg, index) => (
                                    <div
                                        key={index}
                                        className={`chat-message ${
                                            msg.role === 'user' ? 'user-message' : 
                                            msg.content.startsWith('Error:') ? 'error-message' : 'assistant-message'
                                        }`}
                                    >
                                        <div className="font-semibold mb-1">
                                            {msg.role === 'user' ? 'You' : 'Assistant'}
                                        </div>
                                        <div className="whitespace-pre-wrap">{msg.content}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<SpeedReadingChat />, document.getElementById('root'));
    </script>
</body>
</html> 